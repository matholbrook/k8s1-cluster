---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: "deny-deployment-gitrepo-volumes"
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups:   ["apps"]
      apiVersions: ["v1"]
      operations:  ["CREATE", "UPDATE"]
      resources: ["deployments"]
      scope: "Cluster"
  validations:
    - expression: "!( (has(object.spec.template.spec.volumes) && object.spec.template.spec.volumes.exists(v, has(v.gitRepo) )) )"
      message: "Deployments must not use gitRepo volumes."
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: "binding-deny-deployment-gitrepo-volumes"
spec:
  policyName: "deny-deployment-gitrepo-volumes"
  validationActions: [Deny]
#  matchResources:
#    namespaceSelector:
#      matchLabels:
#        environment: test
# apiVersion: admissionregistration.k8s.io/v1
# kind: ValidatingAdmissionPolicy
# metadata:
#   name: "deny-gitrepo-volumes"
# spec:
#   failurePolicy: Fail
#   matchConstraints:
#     resourceRules:
#     - apiGroups:   ["apps", ""]
#       apiVersions: ["v1"]
#       operations:  ["CREATE", "UPDATE"]
#       resources: ["deployments", "pods", "daemonsets", "statefulsets", "replicasets", "jobs", "cronjobs", "replicationcontrollers"]
#       scope: "Cluster"
#   validations:
#     - expression: |
#         !(
#           (has(object.spec.template.spec.volumes) && object.spec.template.spec.volumes.exists(v, has(v.gitRepo))) ||
#           (has(object.spec.volumes) && object.spec.volumes.exists(v, has(v.gitRepo)))
#         )
#       message: "Pods, Deployments, DaemonSets, and StatefulSets must not use gitRepo volumes."